<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    />
    <title>Document</title>
  </head>
  <body>
    <h1>Chat Client</h1>
    <br />

    <div id="console" class="well"></div>

    <form class="well form-inline" onsubmit="return false;">
      <input
        id="msg"
        class="input-xlarge"
        type="text"
        placeholder="Type something..."
      />
      <button type="button" onClick="sendMessage()" class="btn" id="send">
        Send
      </button>
      <button type="button" onClick="sendDisconnect()" class="btn">
        Disconnect
      </button>
    </form>
  </body>

  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"
  ></script>
  <script
    src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"
  ></script>
  <script src="/public/js/socket.io-2.2.0.js"></script>

  <script>
    (async () => {
      var userName = 'user' + Math.floor(Math.random() * 1000 + 1);
      var socket = io('http://localhost:8084/chat?token=abc123', {
        transports: ['polling', 'websocket'],
      });
      socket.on('connect', function () {
        output(
          '<span class="connect-msg">The client has connected with the server. Username: ' +
            userName +
            '</span>',
        );
      });
      socket.on('chat', function (data) {
        console.log('Received message', data);
        output(
          '<span class="username-msg">' +
            data.userName +
            ':</span> ' +
            data.message,
        );
      });
      socket.on('disconnect', function () {
        output(
          '<span class="disconnect-msg">The client has disconnected!</span>',
        );
      });
      socket.on('reconnect_attempt', (attempts) => {
        console.log('Try to reconnect at ' + attempts + ' attempt(s).');
      });

      function sendDisconnect() {
        socket.disconnect();
      }

      function sendMessage() {
        var $msg = $('#msg');
        var message = $msg.val();
        $msg.val('');
        var jsonObject = {
          userName: userName,
          message: message,
          actionTime: new Date(),
        };
        socket.emit('chat', jsonObject);
      }

      function output(message) {
        var currentTime =
          "<span class='time'>" + moment().format('HH:mm:ss.SSS') + '</span>';
        var element = $('<div>' + currentTime + ' ' + message + '</div>');
        $('#console').prepend(element);
      }

      $(document).keydown(function (e) {
        if (e.keyCode == 13) {
          $('#send').click();
        }
      });
    })();
  </script>
</html>
